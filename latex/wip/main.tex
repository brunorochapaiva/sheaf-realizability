\documentclass[11pt]{article}

\newif\ifnotes
\notestrue % comment out to hide notes

\DeclareUnicodeCharacter{03A3}{\(\Sigma\)}
\DeclareUnicodeCharacter{03A0}{\(\Pi\)}
\DeclareFontFamily{U}{min}{}
\DeclareFontShape{U}{min}{m}{n}{<-> udmj30}{}
\newcommand\yo{\!\text{\usefont{U}{min}{m}{n}\symbol{'207}}\!}

\input{packages-to-include}

% Need this nonsense so that cleveref uses the correct names for references
\let\oldtheorem\newtheorem
\RenewDocumentCommand{\newtheorem}{s m o m O{}}{%
\IfBooleanTF{#1}%
{\oldtheorem{#2}{#4}}%
{\IfNoValueTF{#3}{\oldtheorem{#2}{#4}[#5]}%
{\newaliascnt{#2}{#3}%
\oldtheorem{#2}[#2]{#4}%
\aliascntresetthe{#2}}}}

\newtheorem{thrm}{Theorem}[subsection]
\newtheorem{lemm}[thrm]{Lemma}
\newtheorem{prop}[thrm]{Proposition}
\newtheorem{defn}[thrm]{Definition}
\newtheorem{remk}[thrm]{Remark}
\newtheorem{exam}[thrm]{Example}
\newtheorem{cons}[thrm]{Construction}
\newtheorem{coro}[thrm]{Corollary}
\newtheorem{nota}[thrm]{Notation}

\input{macros}

%--------------------------------------------------------------------------------
% Document proper
\begin{document}

\title{Realizability with Sheaves}
\author{Bruno da Rocha Paiva}
\maketitle

We begin a treatment of realizability internal to categories of sheaves.

\section{Preliminaries internally}

For the whole of this section we give definitions and prove some
helpful results in the internal language of an elementary topos \(\E\).
%
In essence we give definitions, statements and proofs informally in type theory.
%
As we are working inside of an elementary topos we may assume propositional
extensionality, functional extensionality and propositional resizing.

\subsection{Lawvere-Tierney topologies}%
\label{sub:lawvere-tierney-internal}

Lawvere-Tierney topologies are an internal representation for subtoposes
of \(\E\).

\begin{defn}\label{defn:lawvere-tierney}
  A \definiendum{Lawvere-Tierney topology} on is a function
  \(\IBoxSym : \Omega \to \Omega\) such that for all propositions \(P,Q\), both
  \(\IImplies{P}{\IBox{P}}\) and
  \(\IImplies{(\IImplies{P}{\IBox{Q}})}{\IImplies{\IBox{P}}{\IBox{Q}}}\) hold.
\end{defn}

\subsection{Sheaves}%
\label{sub:sheaves-internal}

Once we have fixed a Lawvere-Tierney topology \(\IBoxSym : \IProp \to \IProp\),
we have the following internal definition of sheaves:

\begin{defn}
  A type \(A\) is a \definiendum{sheaf} if we have a function
  %
  \[
    \IGlue{A} : (P : \IProp) \to \IHolds{\IBox{P}} \to (\IHolds{P} \to A) \to A
  \]
  %
  such that for all propositions \(P\) and proofs \(q : \IHolds{\IBox{P}}\),
  we have the following equivalence of types:
  %
  \[
    \IGlue{A}\,P\,q : (\IHolds{P} \to A) \cong A : \text{const}
  \]
\end{defn}

We note that as we ask that the \(\text{const}\) function be an equivalence,
being a sheaf is a property of a type \(A\) and not extra structure.
%
In the case that the type \(A\) is a set, which is always true in our setting,
then it is equivalent to prove only that the composite
\((\IGlue{A}\,P\,q) \circ \text{const}\) sends each \(a : A\) to itself.

Any map \(f : A \to B\) induces a map
\((f\circ-) : (\IHolds{P} \to A) \to (\IHolds{P} \to B)\) by post-composition.
%
In the case that \(A\) and \(B\) are both sheaves, then the gluing function
will give a natural transformation.

\begin{prop}
  Given sheaves \(A\) and \(B\), a function \(f : A \to B\), a proposition \(P\)
  and \(q : \IHolds{P}\), then the following naturality square commutes:
  %
  \[\begin{tikzcd}
      (\IHolds{P} \to A) \arrow[rr , "\IGlue{A}\,P\,q"] \arrow[d, "(f\circ-)"'] && A \arrow[d, "f"]\\
      (\IHolds{P} \to B) \arrow[rr , "\IGlue{B}\,P\,q"] && B
    \end{tikzcd}\]
\end{prop}
\begin{proof}
  Fix \(f : A \to B\), a proposition \(P\), \(q : \IHolds{P}\) and
  \(\phi : \IHolds{P} \to A\) so we are left to show that
  \(f(\IGlue{A}\,P\,q\,\phi) = \IGlue{B}\,P\,q\,(f \circ \phi)\).
  %
  Well, we have the following sequence of equalities:
  %
  \begin{align*}
    &f(\IGlue{A}\,P\,q\,\phi)\\
    &\quad=
      f(\IGlue{A}\,P\,q\,(\ILam{p':\IHolds{P}}\phi\,p'))
      \\
    &\quad=
      \IGlue{B}\,P\,q\,(\ILam{p:\IHolds{P}}{f(\IGlue{A}\,P\,q\,(\ILam{p':\IHolds{P}}\phi\,p'))})
      \\
    &\quad=
      \IGlue{B}\,P\,q\,(\ILam{p:\IHolds{P}}{f(\IGlue{A}\,P\,q\,(\ILam{p':\IHolds{P}}\phi\,p))})
      \\
    &\quad=
      \IGlue{B}\,P\,q\,(\ILam{p:\IHolds{P}}{f(\phi\,p)})
      \\
    &\quad=\IGlue{B}\,P\,q\,(f \circ \phi)
  \end{align*}
  %
  where the first and last equalities are \(\eta\)-expansions,
  the second and second to last equalities hold since gluing a constant
  family gives the original element, and the third equality holds
  since \(p\) and \(p'\) are both elements of the same proposition, so they
  are necessarily equal.
\end{proof}

Sheaves have nice closure properties with regards to the constructors of type
theory.

\begin{prop}\label{prop:pi-preserve-sheaf}
  Given a type family \(F : A \to \IUni\) such that for \(Fa\) is a sheaf for
  all \(a : A\), then the dependent product \((a : A) \to Fa\) is also a
  sheaf.
\end{prop}

\begin{prop}\label{prop:sigma-preserve-sheaf}
  Given a type family \(F : A \to \IUni\) such that \(A\) is a sheaf and \(Fa\)
  is a sheaf for all \(a : A\), then the dependent sum \((a : A) \times Fa\)
  is also a sheaf.
\end{prop}

\begin{prop}
  Given a sheaf \(A\) and elements \(a\ b : A\), the identity type \(a = b\) is
  also a sheaf.
\end{prop}

Though we have these closure properties, we have not yet actually seen
any examples of sheaves.
%
For now, the only basic examples of sheaves we have are all related to
\(\IBoxSym\) stable propositions.

\begin{prop}\label{prop:t-stable-iff-sheaf}
  For \(P : \IProp\), the proposition \(\IImplies{\IBox{P}}{P}\) holds if and
  only if \(\IHolds{P}\) is a sheaf.
\end{prop}

\begin{coro}
  The unit type \(\mathbb{1}\) is a sheaf. The empty type
  \(\mathbb{0}\) is a sheaf if and only if \(\IBox{\bot} = \bot\).
\end{coro}

And for the first example of a sheaf which is not a proposition we
have the subtype of propositions which are \(\IBoxSym\)-stable.

\begin{defn}
  The \definiendum{subobject classifier of sheaves}, denoted \(\IPropCl\), is
  given by the subtype of \(\IBoxSym\)-stable propositions, more explicitly it
  is the dependent sum \((P : \IProp) \times \IHolds{\IImplies{\IBox{P}}{P}}\).
\end{defn}

\begin{prop}
  The type \(\IPropCl\) of \(\IBoxSym\)-stable propositions is a sheaf.
\end{prop}

\subsection{Sheafification}%
\label{sub:sheafification-internal}

We are now faced with the fact that there really are not any more sheaves we
can talk about internally, which leaves us at an impasse.
%
Luckily, we can burrow our way out, for we are taking our semantics in \(\E\),
where a myriad of sheaves exist.
%
In particular, for every object \(A\) in \(\E\) there exists a free sheaf on
\(A\); provided we can axiomatise this to a satisfactory degree we can then use
it inside the internal language to talk about many more examples of sheaves.

As usual, we characterise free constructions as left adjoints, so first we
assume we have a sheafification type former
\(\ISheafSym : \IUni \to \IUni\) such that for all \(a : A\), we have
\(\ILeafSym : A \to \ISheaf{A}\) and proof that \(\ISheaf{A}\) is a sheaf.
%
Our second requirement is that, given a type \(A\) and a sheaf \(B\), the
pre-composition map
\(-\circ\ILeafSym : (\ISheaf{A} \to B) \to (A \to B)\) is an equivalence.
%
Given \(f : A \to B\), we denote its transpose across the equivalence by
\(\ISheafExt{f} : \ISheaf{A} \to B\).

\begin{nota}
  By \Cref{prop:pi-preserve-sheaf} we know that the function type
  \(\IFun{Y}{X}\) is a sheaf provided that \(X\) is already a sheaf.
  %
  This means that functions of type \(\IFun{Z}{\IFun{Y}{Z}}\) can be extended in
  three distinct ways: \(\IFun{\ISheaf{Z}}{\IFun{Y}{Z}}\),
  \(\IFun{Z}{\IFun{\ISheaf{Y}}{Z}}\) and
  \(\IFun{\ISheaf{Z}}{\IFun{\ISheaf{Y}}{Z}}\).
  %
  In all cases we glue results in a pointwise fashion along non-sheafified
  arguments.
  %
  To make this clearer, when attempting to sheafify a function
  with multiple arguments we will give a list with entries in \(\{\sharp,\flat\}\)
  to tell, respectively, which arguments we sheafify and which we do not.
  %
  As an example given a function \(f : \IFun{W}{\IFun{Z}{\IFun{Y}{X}}}\), then
  we would have the corresponding
  \(\ISheafExtM{f}{\sharp,\flat,\flat}: \IFun{\ISheaf{W}}{\IFun{Z}{\IFun{Y}{X}}}\)
  or
  \(\ISheafExtM{f}{\flat,\sharp,\sharp}: \IFun{W}{\IFun{\ISheaf{Z}}{\IFun{\ISheaf{Y}}{X}}}\)
\end{nota}

While this adjunction lets us define non-dependent maps out of sheafified
types, we would currently get stuck trying to prove any properties
about these maps.
%
For that, we need to recover a dependent elimination principle, which we
can do through the use of the total space of a type family.

\begin{prop}\label{prop:sheafification-elim-principle}
Given a type \(A\) and a type family \(F : \ISheaf{A} \to \IUni\) such that
\(Fd\) is a sheaf for all \(d : \ISheaf{A}\), then for any
\(f : (a : A) \to F(\ILeaf{a})\) there exists a unique function
\(\ISheafInd{f} : (d : \ISheaf{A}) \to Fd\) satisfying
\(f = \ISheafInd{f} \circ \ILeafSym\).
\end{prop}
\begin{proof}
  The adjunction only lets us transpose non-dependent maps out of \(A\),
  so we first define:
  \begin{align*}
    &s : A \to \IProd{(d : \ISheaf{A})}{Fd}\\
    &s\,a \IsDefined \IPair{\ILeaf{a}}{f\,a}
  \end{align*}
  %
  Since \(\ISheaf{A}\) is a sheaf, and so are all the fibers of \(F\), we know
  by~\Cref{prop:sigma-preserve-sheaf} that the total space of \(F\) is a sheaf,
  hence we can take the transpose of \(s\) to get a map
  \(\ISheafExt{s} : \ISheaf{A} \to \IProd{(d : \ISheaf{A})}{Fd}\).
  %
  A quick computation shows that
  \(\IFst \circ \ISheafExt{s} \circ \ILeafSym = \IFst \circ s = \ILeafSym\),
  but pre-composition with \(\ILeafSym\) is an equivalence so that
  implies that \(\IFst \circ \ISheafExt{s}\) is the identity.
  %
  From the fact that \(\ISheafExt{s}\) is a section of \(\IFst\), we see that
  \(\ISnd \circ \ISheafExt{s}\) has the type required, so we are left to
  show the required equation.
  %
  This holds as we have~\(f = \ISnd \circ s = \ISnd \circ \ISheafExt{s} \circ \ILeafSym\).
  %
  For the uniqueness part suppose we have two candidates
  \(g,h : (d : \ISheaf{A}) \to Fd\) satisfying
  \(f = g\circ\ILeafSym = h\circ\ILeafSym\), then
  \(\IProd{\text{id}}{g} = \IProd{\text{id}}{h}\) because these agree on
  the image of \(\ILeafSym\).
  %
  But now
  \(g = \ISnd \circ (\IProd{\text{id}}{g}) = \ISnd \circ (\IProd{\text{id}}{h}) = h\) as needed.
\end{proof}

As a corollary of this elimination principle, we now see how to reason
about predicates on sheafified types.
%
In particular, we only have a good grasp on these if they are
\(\IBoxSym\)-stable.

\begin{coro}\label{prop:stable-predicate-induction}
  Given a predicate \(P : X \to \IPropCl\), if \(P x\) holds for all \(x : X\),
  then also \(\ISheafExt{P}d\) holds for all \(d : \ISheaf{X}\).
\end{coro}
\begin{proof}
  The type family
  \(F\,X \IsDefined \IHolds{P\,X}\) is fiberwise a sheaf, so we may
  apply~\Cref{prop:sheafification-elim-principle}.
\end{proof}

As we saw, the property of being a sheaf is a well-behaved one with respect
to constructors of type theory.
%
It is no surprise then that sheafification also seems to play well with these,
for example commuting with dependent sums and products.
%
The result for dependent sums will be of particular interest later since
we will use these to extend predicates to partial elements.

\begin{prop}
  Given a type \(A\) and a family \(F : \ISheaf{A} \to \IUni\) which is
  fiberwise a sheaf, then we have the following equivalences of types:
  %
  \begin{align*}
    \ISheaf{(\IProd{(a : A)}{F(\ILeaf{a})})}
    &\cong
    \IProd{(d : \ISheaf{A})}{F\,d}
    \\
    \ISheaf{(\IFun{(a : A)}{F(\ILeaf{a})})}
    &\cong
    \IFun{(d : \ISheaf{A})}{F\,d}
  \end{align*}
\end{prop}
\begin{proof}
  First we focus on the equivalence for dependent sums. For the forward
  direction, as \(F\) is fiberwise a sheaf, it suffices to give a map
  \(\IProd{(a : A)}{F(\ILeaf{a})} \to \IProd{(d : \ISheaf{A})}{F\,d}\).
  %
  This map is given coordinate wise as \(\IProd{\ILeafSym}{\text{id}}\).
  %
  For the reverse direction, by using the dependent elimination principle and
  uncurrying, all we are left to do is define a function
  \((a : A) \to F(\ILeaf{a}) \to \ISheaf{(\IProd{(a : A)}{F(\ILeaf{a})})}\).
  %
  For this we use \(\ILam{a:A}{\ILam{x:F(\ILeaf{a})}{\ILeaf{\IPair{a}{x}}}}\).
  %
  We are left to show that both round-trips are equal to the identity and
  for this we simply need to check them on the image of \(\ILeafSym\).
  %
  This amounts to the fact that for all \(a : A\) and \(x : F(\ILeaf{a})\)
  we have:

  \begin{minipage}[c]{0.25\textwidth}
    \begin{align*}
      &\ISheafExt{(\IProd{\ILeafSym}{\text{id}})}(\ILeaf{\IPair{a}{x}})
      \\
      &\quad=
        (\IProd{\ILeafSym}{\text{id}})\IPair{a}{x}
      \\
      &\quad=
        \IPair{\ILeaf{a}}{x}
    \end{align*}
  \end{minipage}
  \begin{minipage}[c]{0.74\textwidth}
    \begin{align*}
      &\text{uncurry}(\ISheafExt{(\ILam{a:A}{\ILam{x:F(\ILeaf{a})}{\ILeaf{\IPair{a}{x}}}})})\IPair{\ILeaf{a}}{x}
      \\
      &\quad=
        \ISheafExt{(\ILam{a:A}{\ILam{x:F(\ILeaf{a})}{\ILeaf{\IPair{a}{x}}}})}\,(\ILeaf{a})\,x
      \\
      &\quad=
        (\ILam{a:A}{\ILam{x:F(\ILeaf{a})}{\ILeaf{\IPair{a}{x}}}})\,a\,x
      \\
      &\quad=
        \ILeaf{\IPair{a}{x}}
    \end{align*}
  \end{minipage}

  \hspace{0pt}

  The ideas for the dependent product equivalence are similar.
  %
  For the forwards direction we use the extension \(\ISheafExt{\ISheafIndSym}\),
  while for the backwards directions we use the map
  \(\ILeafSym \circ (-\circ\ILeafSym)\).
  %
  First we check the forward then backwards round-trip: given some
  \(f : \ISheaf{(\IFun{(a:A)}{F(\ILeaf{a})})}\to\IFun{(d:\ISheaf{A})}{Fd}\),
  we have
  \(
    (\ISheafExt{\ISheafIndSym}(\ILeafSym (f\circ\ILeafSym)))
    =
    \ISheafInd{(f\circ\ILeafSym)}
  \).
  %
  To check the right-hand side equals \(f\), we can just check they agree
  when precomposed with \(\ILeafSym\).
  %
  This is true as
  \(\ISheafInd{(f\circ\ILeafSym)}\circ\ILeafSym = f\circ\ILeafSym\)
  holds by \Cref{prop:sheafification-elim-principle}.
  %
  For the other round-trip we again check that both maps
  agree when precomposed with \(\ILeafSym\): given
  \(f : \IFun{(a:A)}{F(\ILeaf{a})}\) we have
  %
  \(
    \ILeafSym{(\ISheafExt{\ISheafIndSym}(\ILeafSym{f})\circ\ILeafSym)}
    =
    \ILeafSym{(\ISheafInd{f}\circ\ILeafSym)}
    =
    \ILeafSym{f}
   \).
\end{proof}

\begin{prop}\label{prop:boxed-sigma-boxed}
  Given a type \(A\) and a family \(F : A \to \IUni\) we have the following
  equivalences:
  %
  \begin{align*}
    \ISheaf{(\IProd{(a : A)}{Fa})}
    &\cong
    \ISheaf{(\IProd{(a : A)}{\ISheaf{(Fa)}})}
  \end{align*}
\end{prop}
\begin{proof}
  We define the forward and backwards maps as follows:
  %
  \[
    \begin{array}{l}
      f : \IFun{\ISheaf{(\IProd{(a : A)}{Fa})}}{\ISheaf{(\IProd{(a : A)}{\ISheaf{(Fa)}})}}
      \\
      f \IsDefined \ISheafMap{(\ILamU{\IPair{a}{x}}{\IPair{a}{\ILeaf{x}}})}
      \\[1em]
      g : \IFun {\ISheaf{(\IProd{(a : A)}{\ISheaf{(Fa)}})}}{\ISheaf{(\IProd{(a : A)}{Fa})}}
      \\
      g \IsDefined \ISheafExt{(\ILamU{\IPair{a}{d}}{(\ISheafMap{(\ILamU{x}{\IPair{a}{x}})}\,d)})}
    \end{array}
  \]
  %
  We prove that \(g \circ f\) equals the identity by precomposing
  with \(\ILeafSym\).
  %
  Fix \(a:A\) and \(x:Fa\), then
  \begin{align*}
    (g \circ f)(\ILeaf{\IPair{a}{x}})
    &=
      \ISheafExt{(\ILamU{\IPair{a}{d}}{(\ISheafMap{(\ILamU{x}{\IPair{a}{x}})}\,d)})}
      \big(\ISheafMap{(\ILamU{\IPair{a}{x}}{\IPair{a}{\ILeaf{x}}})}(\ILeaf{\IPair{a}{x}})\big)
    \\
    &=
      \ISheafExt{(\ILamU{\IPair{a}{d}}{(\ISheafMap{(\ILamU{x}{\IPair{a}{x}})}\,d)})}
      (\ILeaf{\IPair{a}{\ILeaf{x}}})
    \\
    &=
      (\ISheafMap{(\ILamU{x}{\IPair{a}{x}})}\,(\ILeaf{x}))
    \\
    &= \ILeaf{\IPair{a}{x}}
  \end{align*}
  %
  We check the remaining roundtrip equation similarly by fixing \(a:A\) and
  \(d:\ISheaf{(Fa)}\) so
  \begin{align*}
    (f \circ g)(\ILeaf{\IPair{a}{d}})
    &=
      \ISheafMap{(\ILamU{\IPair{a}{x}}{\IPair{a}{\ILeaf{x}}})}
      \big(\ISheafExt{(\ILamU{\IPair{a}{d}}{(\ISheafMap{(\ILamU{x}{\IPair{a}{x}})}\,d)})}(\ILeaf{\IPair{a}{d}})\big)
    \\
    &=
      \ISheafMap{(\ILamU{\IPair{a}{x}}{\IPair{a}{\ILeaf{x}}})}
      (\ISheafMap{(\ILamU{x}{\IPair{a}{x}})}\,d)
    \\
    &=
      (\ISheafMap{(\ILamU{x}{\IPair{a}{\ILeaf{x}}})}\,d)
    \\
    &= \ILeaf{\IPair{a}{d}}
  \end{align*}
  where for the last equality is proven for all \(d:\ISheaf{(Fa)}\) by checking
  it holds on the image of the adjunction unit.
\end{proof}

\begin{prop}
  For a proposition \(P : \IProp\), its sheafification \(\ISheaf{\IHolds{P}}\)
  is equivalent as a type to~\(\IHolds{\IBox{P}}\).
\end{prop}
\begin{proof}
  First we define the forward direction
  \(f : \IHolds{\IBox{P}} \to \ISheaf{\IHolds{P}}\):
  %
  given \(q : \IHolds{\IBox{P}}\), since \(\ISheaf{\IHolds{P}}\) is a sheaf,
  we have the map
  \(\IGlue{\ISheaf{\IHolds{P}}}\,P\,q : (\IHolds{P} \to \ISheaf{\IHolds{P}}) \to \IHolds{P}\)
  so we set
  \(f(q) \IsDefined \IGlue{\ISheaf{\IHolds{P}}}\,P\,q\,\ILeafSym\).
  %
  For the backwards direction we wish to define
  \(g : \ISheaf{\IHolds{P}} \to \IHolds{\IBox{P}}\).
  %
  By~\Cref{prop:t-stable-iff-sheaf} we know that \(\IHolds{\IBox{P}}\)
  is a sheaf, so it suffices to define a map
  \(\IHolds{P} \to \IHolds{\IBox{P}}\) which follows from the
  definition of a Lawvere-Tierney topology.

  We must still check that both composites are equal to the identity.
  %
  The composite \(g\circ f\) is immediately equal to the identity as
  \(\IHolds{\IBox{P}}\) is a proposition.
  %
  As for \(f \circ g\), it suffices to check that
  \(f\circ g\circ \ILeafSym = \ILeafSym\).
  %
  So given \(p : \IHolds{P}\) we have:
  %
  \begin{align*}
    (f \circ g \circ \ILeafSym)\,p
    &=
      \IGlue{\ISheaf{\IHolds{P}}}\,P\,(gp)\,(\ILam{q:\IHolds{P}}{\ILeaf{q}})
    \\
    &=
      \IGlue{\ISheaf{\IHolds{P}}}\,P\,(gp)\,(\ILam{q:\IHolds{P}}{\ILeaf{p}})
    \\
    &=
      \ILeaf{p}
  \end{align*}
  %
  where in the first equality we simply unfolded definitions and did some
  \(\eta\)-expansion, the second equality holds as \(P\) is a proposition and so
  \(p = q\), and the third equality holds by the uniqueness condition of gluing.
\end{proof}

\begin{coro}
  Given a type \(A\) and a \(\IBoxSym\)-stable predicate
  \(P:A\to\IPropCl\), then we have
  %
  \[
    \IBox{(\IForall{a:A}{Pa})}
    \Leftrightarrow
    \IForall{d:\ISheaf{A}}{\ISheafExt{P}d}
  \]
  %
  In the case of a proposition \(Q:\IProp\) and
  a \(\IBoxSym\)-stable predicate \(P:\IHolds{Q}\to\IPropCl\), then we also have
  %
  \[
    \IBox{(\IExists{q:\IHolds{Q}}{Pq})}
    \Leftrightarrow
    \IExists{h:\IHolds{\IBox{Q}}}{\ISheafExt{P}q}
  \]
\end{coro}

\begin{prop}\label{prop:heyting-structure-predicate-extension}
  Given predicates \(P,Q : X \to \IPropCl\) and \(R : X \to Y \to \IPropCl\) we
  have the following equivalences:
  \begin{align*}
    \ISheafExt{(\IAnd{P}{Q})}d
    &\Leftrightarrow
      \IAnd{\ISheafExt{P}d}{\ISheafExt{Q}d}
    \\
    \ISheafExt{(\IBox{(\IOr{P}{Q})})}d
    &\Leftrightarrow
      \IBox{(\IOr{\ISheafExt{P}d}{\ISheafExt{Q}d})}
    \\
    \ISheafExt{(\IImplies{P}{Q})}d
    &\Leftrightarrow
      \IImplies{\ISheafExt{P}d}{\ISheafExt{Q}d}
    \\
    \ISheafExt{(\IForall{y:Y}{R\,(-)\,y})}d
    &\Leftrightarrow
      \IForall{y:Y}{\ISheafExtM{R}{\sharp,\flat}\,d\,y}
  \end{align*}
\end{prop}
\begin{proof}
  It suffices to show these all agree when precomposed with \(\ILeafSym\), which
  holds immediately as \(\IAndSym\), \(\IBoxSym\), \(\IOrSym\) and
  \(\IImpliesSym\) are all extended to act on predicates pointwise.
\end{proof}

\subsection{Lifting monad and partiality}

We may define the lifting monad in any topos internally, which will then
let us speak of partial functions --- a crucial ingredient of realizability
and even more so when we look at choice sequences.

\begin{defn}\label{defn:lifting}
  We define the \definiendum{lifting of a type \(X\)} as the dependent sum
  \(\IPar{X} \IsDefined \IProd{(P : \IProp)}{\IHolds{P}\to X}\).
  %
  Given an element \(x : \IPar{X}\) we denote its first projection by
  \(\ITotal{x} : \IProp\) and its second projection by
  \(\IVal{x}: \IHolds{\ITotal{x}} \to X\).
\end{defn}

\begin{prop}
  The lifting of a type \(\IPar{(-)}\) gives a monad.
\end{prop}

The monadic structure of partial elements is by itself not enough to get
a realizability tripos though, we must also know how to extend predicates on
a type \(X\) to predicates on its lifting.
%
This is the role of modal operators~\cite{moggiNotionsComputationMonads1991},
which each induce a modality in the sense
of~\cite{cohenPartialMonadicCombinatory2025}.

\begin{prop}
  The folowing define algebras for the lifting monad
  with \(\IProp\) as carrier.
  \[\arraycolsep=2em
    \begin{array}{ll}
      \ISquashSym : \IPar{\IProp} \to \IProp
      &
        \ISquishSym : \IPar{\IProp} \to \IProp
      \\
      \ISquash{\phi} \IsDefined \IProd{(h:\IHolds{\ITotal{\phi}})}{\IHolds{\IVal{\phi}\,h}}
      &
        \ISquish{\phi} \IsDefined \IFun{(h:\IHolds{\ITotal{\phi}})}{\IHolds{\IVal{\phi}\,h}}
    \end{array}
  \]
\end{prop}

These are of course related, with the former implying the second.
%
Unsurprisingly, their difference is exactly that the latter does not guarantee
that the partial proposition is defined, at which point they are equivalent.

\begin{prop}\label{prop:squash-and-squish}
  For any partial proposition \(\phi:\IPar{\IProp}\) we have the equivalence
  \(\IIFF{\ISquash{\phi}}{\IAnd{\ITotal{\phi}}{\ISquish{\phi}}}\).
\end{prop}

This explains why only \(\ISquashSym\) seems to feature (implicitly) in
realizability interpretations.
%
Without the requirement that computations terminate we find ourselves able to
realize everything, which leads to problems.
%
However, once we have a way to meaningfully weaken \(\ITotal{a}\), such as
through the use of a Lawvere-Tierney topology, then \(\ISquishSym\) would become
useful again.

\begin{prop}\label{prop:boxed-squash-and-boxed-squish}
  Fora any partial proposition \(\phi : \IPar{\IProp}\) we have
  \(\IImplies{\IAnd{\IBox{(\ITotal{\phi})}}{\ISquish{\phi}}}{\IBox{(\ISquash{\phi})}}\).
  %
  In the case that \(\phi\) is a partial \(\IBoxSym\)-stable proposition, that
  is \(\phi : \IPar{(\IPropCl)}\), then the converse holds aswell.
\end{prop}
\begin{proof}
  Notice that by~\Cref{prop:squash-and-squish} and the fact that \(\IBoxSym\)
  preserves conjunctions we have
  %
  \[
    \IIFF%
    {\IBox{(\ISquash{\phi})}}%
    {\IAnd{\IBox{(\ITotal{\phi})}}{\IBox{(\ISquish{\phi})}}}
  \]
  %
  and \(\IAnd{\IBox{(\ITotal{\phi})}}{\ISquish{\phi}}\) implies the right hand
  side as \(\IBoxSym\) is inflationary.
  %
  If in addition we know that \(\phi\) is \(\IBoxSym\)-stable,
  then \(\IImplies{\IBox{(\ISquish{\phi})}}{(\ISquish{\phi})}\) so
  we get the desired equivalence.
\end{proof}

So in the case of stable propositions, weakening \(\ITotal{\phi}\) is equivalent
to weakening the whole requirement that the proposition is defined and true.

\begin{defn}
  We define the \definiendum{existential and universal liftings of a predicate
    \(P : X \to \IProp\)} as the following respective predicates on
  \(\IPar{X}\):
  %
  \[\arraycolsep=2em
    \begin{array}{ll}
      \IParEExt{P} : \IPar{X} \to \IProp
      &
        \IParUExt{P} : \IPar{X} \to \IProp
      \\
      \IParEExt{P} \IsDefined \ISquashSym\circ\IPar{P}
      &
        \IParUExt{P} \IsDefined \ISquishSym\circ\IPar{P}
    \end{array}
  \]
\end{defn}

\begin{nota}
  In later sections we will abuse notation and given a predicate
  \(P : A \to \IProp\) and partial element \(a : \IPar{A}\) write
  \(\IAnd{\ITotal{a}}{P\,a}\) to mean \(\IParEExt{P}\,a\) and
  \(\IImplies{\ITotal{a}}{P\,a}\) instead of \(\IParUExt{P}\,a\).
\end{nota}

\begin{prop}\label{prop:boxed-existential-partial-extension}
  Fix a \(\IBoxSym\)-stable predicate \(P : X \to A \to \IPropCl\)
  and a partial element \(a : \IPar{A}\).
  %
  We define two stable predicates on \(X\) and \(\ISheaf{X}\) as follows:
  %
  \[\arraycolsep=2em
    \begin{array}{ll}
      Q:\IFun{X}{\IPropCl}
      &
        R:\IFun{\ISheaf{X}}{\IPropCl}
      \\
      {Qx} \IsDefined {\IBox{(\IParEExt{(P\,x)}\,a)}}
      &
        {Rd} \IsDefined {\IBox{(\IParEExt{(\IRPExt{P}\,d)}\,a)}}
    \end{array}
  \]
  Then the extension \(\ISheafExt{Q}:\IFun{\ISheaf{X}}{\IPropCl}\) of \(Q\)
  coincides with \(R\).
\end{prop}
\begin{proof}
  We show them equivalent by the two checking agree
  when precomposed with \(\ILeafSym\).
  %
  Given \(x : X\), we then compute
  %
  \[
    \ISheafExt{Q}(\ILeaf{x})
    = Qx
    = \IBox{(\IParEExt{(P\,x)}\,a)}
    = \IBox{(\IParEExt{(\ISheafExt{P}(\ILeaf{x}))}\,a)}
    = R(\ILeaf{x})
  \]
  which finishes the proof.
\end{proof}

\newpage

\section{Realizability Triposes for Forcing Semantics}

In this section we fix a topos \(\E\) along with a Lawvere-Tierney
topology \(\IBoxSym : \IProp \to \IProp\) and a partial combinatory
algebra \(\A\) inside \(\E\).
%
Unless mentioned otherwise all definitions and results are given
internally to \(\E\).

Once we have fixed an internal partial combinatory algebra and a Lawvere-Tierney
topology we have (at least) three sensible options for defining a realizability
tripos:
\begin{enumerate}
  \item We can ignore \(\IBoxSym\) and define the usual realizability tripos
    with predicates \(\phi,\psi:\IRealPred{X}\).
    %
    The relevant notion of implication between predicates is then that \(\phi\)
    implies \(\psi\) if there exists a realizer \(e:\A\) such that for all
    \(x:X\) and \(a:\A\) satisfying \(\phi\,x\,a\), we have
    \(\IAnd{\ITotal{\IAp{e}{a}}}{\psi\,x\,(\IAp{e}{a})}\).
    %
    The definition of the tripos continues exactly like set based realizability,
    though now working internally to \(\E\).
    %
    We don't explore much this option as the requirement that
    \(\ITotal{\IAp{e}{a}}\) is much too strong for a treatment of choice
    sequences: in the presheaf case this will correspond to asking that an
    application be defined immediately, but we want to be able to delay
    computations to a bar of the current world.

  \item We can modify the ordering by asking that \(\phi\,x\,a\) implies
    \(\IBox{(\IAnd{\ITotal{\IAp{e}{a}}}{\psi\,x\,(\IAp{e}{a})})}\), which lets
    us delay the requirement that \(\IAp{e}{a}\) be defined and a realizer for
    \(\psi\).
    %
    This definition is explored in~\cite{vanoostenExercisesRealizability2018},
    where it is shown to give a tripos and a few properties are proven which we
    recall in \Cref{sub:vo-tripos}.
    %
    As a result of including \(\psi\,x\,(\IAp{e}{a})\) under the modality
    \(\IBoxSym\) we increase the logical power a bit too much and restrict
    ourselves to essentially working with only sheaves.
    %
    This is a somewhat surprising result so we will return to it and discuss
    some of the intuition later.

  \item {\color{red} todo: describe third option}


\end{enumerate}

\subsection{Tripos delaying computation}

\begin{defn}\label{defn:tripos-predicates}
  Given a type \(X\), we define \definiendum{realizability predicates
  on \(X\)} as the function space \(\IRealPred{X}\).
\end{defn}

\begin{defn}\label{defn:tripos-ordering}
  Given a type \(X\) and realizability predicates \(\phi,\psi : \IRealPred{X}\)
  we define the \definiendum{evidence predicate for \(\TLeq{\phi}{\psi}\)} as
  follows:
  %
  \begin{align*}
    \IEvidence{\phi}{\psi}
    &: \IRealPred{X}
    \\
    {\IEvidence{\phi}{\psi}\,x\,e}
    &\IsDefined
      \IForall%
      {a:\A}%
      {\IImplies%
      {\phi\,x\,a}%
      {\IAnd%
      {\IBox{(\ITotal{\IAp{e}{a}})}}%
      %{\IParUExt{(\psi\,x)}\,(\IAp{e}{a})}}}
      {(\IImplies{\ITotal{\IAp{e}{a}}}{\psi\,x\,(\IAp{e}{a})})}}}
  \end{align*}
  %
  We then define the \definiendum{ordering \(\TLeqSym\) on realizability
    predicates} by saying \(\TLeq{\phi}{\psi}\) if there exists a
  code~\(e : \A\) such that for all \(x : X\) we have
  \(\IEvidence{\phi}{\psi}\,x\,e\).
\end{defn}

\begin{prop}
  For all types \(X\), the type \(\IRealPred{X}\) equipped with the
  ordering \(\TLeqSym\) is a Heyting prealgebra.
\end{prop}
\begin{proof}
  For any \(\phi : \IRealPred{X}\) and \(x:X\) we have
  \(\IEvidence{\phi}{\phi}\,x\,\IIdentCode\) as \(\IAp{\IIdentCode}{a}=a\),
  so \(\TLeqSym\) is reflexive.
  %
  To show transitivity we assume that \(\TLeq{\phi}{\psi}\) is evidenced
  by \(e_{0}\) and \(\TLeq{\psi}{\chi}\) is evidenced by \(e_{1}\).
  %
  With this, we can see that \(\IAbs{a}{\IPAp{e_{1}}{(\IPAp{e_{0}}{a})}}\)
  evidences \(\TLeq{\phi}{\chi}\).
  %
  If \(\phi\,x\,a\), then by assumption \(\IBox{(\ITotal{\IAp{e_{0}}{a}})}\)
  and \(\IImplies{\ITotal{\IAp{e_{0}}{a}}}{\psi\,x\,(\IAp{e_{0}}{a})}\).
  %
  Composing with our second assumption we see that
  %
  \[
    \IImplies%
    {\ITotal{\IAp{e_{0}}{a}}}%
    {\IAnd%
      {\IBox{(\ITotal{\IAp{e_{1}}{(\IAp{e_{0}}{a})}})}}%
      {(\IImplies%
        {\ITotal{\IAp{e_{1}}{(\IAp{e_{0}}{a})}}}%
        {\chi\,x\,(\IAp{e_{1}}{(\IAp{e_{0}}{a})})})%
      }%
    }
  \]
  but using the fact that \(\IBoxSym\) is monotonic and idempotent, along with
  \(\IPLeq{\IAp{e_{1}}{(\IAp{e_{0}}{a})}}{\IAp{(\IAbs{a}{\IPAp{e_{1}}{(\IPAp{e_{0}}{a})}})}{a}}\)
  we can prove the conjunction
  %
  \[
    \IAnd%
    {\IBox{(\ITotal{\IAp{(\IAbs{a}{\IPAp{e_{1}}{(\IPAp{e_{0}}{a})}})}{a}})}}%
    {(\IImplies%
      {\ITotal{\IAp{(\IAbs{a}{\IPAp{e_{1}}{(\IPAp{e_{0}}{a})}})}{a}}}%
      {\chi\,x\,(\IAp{(\IAbs{a}{\IPAp{e_{1}}{(\IPAp{e_{0}}{a})}})}{a})})%
    }
  \]
  which finishes the proof of transitivity.

  With the knowledge that we have a preorder, we are now left to show
  it has all finite meets and joins as well as Heyting implication:
  \begin{itemize}
    \item The constantly true and constantly false realizability predicates
      defined by
      %
      \[\begin{array}{lll}
          \TTop : \IRealPred{X} &\qquad& \TBot : \IRealPred{X}\\
          {\TTop\,x\,a}\IsDefined{\top}&& {\TBot\,x\,a}\IsDefined{\bot}
        \end{array}\]
      %
      give, respectively, a top and bottom element.
      %
      Fix some predicate \(\phi : \IRealPred{X}\), then
      \(\IEvidence{\TBot}{\phi}\,x\,e\) holds vacuously for any \(x : X\) and
      code \(e : \A\).
      %
      On the other hand, as long as we pick \(e\) such that \(\IAp{e}{a}\) is
      defined for all \(a:\A\), then \(\IEvidence{\phi}{\TTop}\,x\,e\) holds
      for \(x :X\).

    \item Given two realizability predicates \(\phi,\psi\), their meet is given
      by
      %
      \[
        \begin{array}{l}
          \phantom{(}\TAnd{\phi}{\psi} : \IRealPred{X}
          \\
          {(\TAnd{\phi}{\psi})\,x\,a}
          \IsDefined
          {\IAnd%
          {(\IAnd{\ITotal{\IPAp{\IFstCode}{a}}}{\phi\,x\,(\IPAp{\IFstCode}{a})})}%
          {(\IAnd{\ITotal{\IPAp{\ISndCode}{a}}}{\psi\,x\,(\IPAp{\ISndCode}{a})})}
          }
        \end{array}
      \]
      %
      First we show that \(\IFstCode\) evidences
      \(\TLeq{\TAnd{\phi}{\psi}}{\phi}\) since if
      \((\TAnd{\phi}{\psi})\,x\,a\) then \(\ITotal{\IPAp{\IFstCode}{a}}\) and
      \(\phi\,x\,(\IPAp{\IFstCode}{a})\).
      %
      The symmetric argument also shows that \(\ISndCode\) evidences
      \(\TLeq{\TAnd{\phi}{\psi}}{\psi}\).

      Next, suppose that we have \(e_{0}\) evidences \(\TLeq{\chi}{\phi}\) and
      \(e_{1}\) evidences \(\TLeq{\chi}{\psi}\), then we can show that
      \(\TLeq{\chi}{\TAnd{\phi}{\psi}}\) is evidenced by
      \(\IAbs{a}{\IPAp{\IPAp{\IPairCode}{(\IPAp{e_{0}}{a})}}{(\IPAp{e_{1}}{a})}}\).
      %
      Note that for all \(a:\A\) we have
      %
      \begin{gather*}
        \IIFF%
        {\IAnd{(\ITotal{\IAp{e_{0}}{a}})}{(\ITotal{\IAp{e_{1}}{a}})}}%
        {\ITotal{\IAp{(\IAbs{a}{\IPAp{\IPAp{\IPairCode}{(\IPAp{e_{0}}{a})}}{(\IPAp{e_{1}}{a})}})}{a}}}
        \\
        \IPLeq%
        {\IAp{\IFstCode}{(\IAp{(\IAbs{a}{\IPAp{\IPAp{\IPairCode}{(\IPAp{e_{0}}{a})}}{(\IPAp{e_{1}}{a})}})}{a})}}%
        {\IAp{e_{0}}{a}}
        \\
        \IPLeq%
        {\IAp{\ISndCode}{(\IAp{(\IAbs{a}{\IPAp{\IPAp{\IPairCode}{(\IPAp{e_{0}}{a})}}{(\IPAp{e_{1}}{a})}})}{a})}}%
        {\IAp{e_{1}}{a}}
      \end{gather*}
      %
      Now, if \(\chi\,x\,a\), then by the assumption that \(e_{0}\) and \(e_{1}\)
      evidence \(\TLeq{\chi}{\phi}\) and \(\TLeq{\chi}{\psi}\) we have
      \begin{gather*}
        \IAnd{\IBox{(\ITotal{\IAp{e_{0}}{a}})}}{(\IImplies{\ITotal{\IAp{e_{0}}{a}}}{\phi\,x\,(\IAp{e_{0}}{a})})}
        \\
        \IAnd{\IBox{(\ITotal{\IAp{e_{1}}{a}})}}{(\IImplies{\ITotal{\IAp{e_{1}}{a}}}{\psi\,x\,(\IAp{e_{1}}{a})})}
      \end{gather*}
      which, as needed for \(\TAnd{\phi}{\psi}\) to be the greatest lower bound,
      implies both of the following,
      %
      \begin{gather*}
        \IBox{(\ITotal{\IAp{(\IAbs{a}{\IPAp{\IPAp{\IPairCode}{(\IPAp{e_{0}}{a})}}{(\IPAp{e_{1}}{a})}})}{a}})}
        \\
        \IImplies%
        {\ITotal{\IAp{(\IAbs{a}{\IPAp{\IPAp{\IPairCode}{(\IPAp{e_{0}}{a})}}{(\IPAp{e_{1}}{a})}})}{a}}}%
        {(\TAnd{\phi}{\psi})\,x\,(\IAp{(\IAbs{a}{\IPAp{\IPAp{\IPairCode}{(\IPAp{e_{0}}{a})}}{(\IPAp{e_{1}}{a})}})}{a})}
      \end{gather*}

    \item Given two realizability predicates \(\phi,\psi\), their join is given
      by
      %
      \[\begin{array}{l}
          \phantom{(}\TOr{\phi}{\psi} : \IRealPred{X}
          \\
          {(\TOr{\phi}{\psi})\,x\,a}
          \IsDefined
          \IExists{b:\A}{{\IOr%
          {(\IAnd{{a}={\IPAp{\ILeftCode}{b}}}{\phi\,x\,b})}%
          {(\IAnd{{a}={\IPAp{\IRightCode}{b}}}{\psi\,x\,b})}
          }}
        \end{array}\]
      We show that \(\ILeftCode\) evidences \(\TLeq{\phi}{\TOr{\phi}{\psi}}\)
      and note the symmetric argument works for \(\IRightCode\)
      and \(\TLeq{\psi}{\TOr{\phi}{\psi}}\).
      %
      Suppose that \(\phi\,x\,a\), then \(\ITotal{\IAp{\ILeftCode}{a}}\) and it
      follows that \((\TOr{\phi}{\psi})\,x\,(\IAp{\ILeftCode}{a})\).

      To show the least upper bound property, assume \(e_{0}\) evidences
      \(\phi \leq \chi\) and \(e_{1}\) evidences \(\psi \leq \chi\), then we
      will see that \(\IAp{\IAp{\IMatchCode}{e_{0}}}{e_{1}}\)
      evidences \(\TLeq{\TOr{\phi}{\psi}}{\chi}\):
      %
      fix some \(b:\A\) and assume \(a=\IAp{\ILeftCode}{b}\) and \(\phi\,x\,b\),
      then
      \(\IPSim{\IAp{\IAp{\IAp{\IMatchCode}{e_{0}}}{e_{1}}}{a}}{\IAp{e_{0}}{b}}\),
      so we can prove
      %
      \[
      \IAnd%
      {\IBox{(\ITotal{\IAp{\IAp{\IAp{\IMatchCode}{e_{0}}}{e_{1}}}{a}})}}%
      {(\IImplies%
      {(\ITotal{\IAp{\IAp{\IAp{\IMatchCode}{e_{0}}}{e_{1}}}{a}})}%
      {\chi\,x\,(\IAp{\IAp{\IAp{\IMatchCode}{e_{0}}}{e_{1}}}{a})})%
      }
      \]
      %
      from the analogous result for \(\IAp{e_{0}}{b}\), which holds by
      assumption.
      %
      The case that \(a\) is actually a right injection follows similarly.


    \item Given two realizability predicates \(\phi,\psi\), their Heyting
      implication is given by
      %
      \[\begin{array}{l}
          \phantom{(}\TImplies{\phi}{\psi} : \IRealPred{X}
          \\
          {(\TImplies{\phi}{\psi})\,x\,a}
          \IsDefined
          {\IEvidence{\phi}{\psi}\,x\,a}
        \end{array}\]
      %
      Suppose that \(\TLeq{\phi}{\TImplies{\psi}{\chi}}\) is evidenced
      by \(e\), then \(\TLeq{\TAnd{\phi}{\psi}}{\chi}\) is
      evidenced by
      %
      \[
      \IAbs{a}{\IPAp{\IPAp{e}{(\IPAp{\IPAp{\IFstCode}{a}})}}{(\IPAp{\IPAp{\ISndCode}{a}})}}
      \]
      since if \((\TAnd{\phi}{\psi})\,x\,a\), then we have
      \(\phi\,x\,(\IAp{\IFstCode}{a})\) and \(\psi\,x\,(\IAp{\ISndCode}{a})\).
      %
      The former of these implies that
      \(\IBox{(\ITotal{\IAp{e}{(\IAp{\IFstCode}{a})}})}\) and
      \(\IEvidence{\psi}{\chi}\,x\,(\IAp{e}{(\IAp{\IFstCode}{a})})\),
      from which we get
      %
      \[
      \IAnd
      {\IBox{(\ITotal{\IAp{\IAp{e}{(\IAp{\IFstCode}{a})}}{(\IAp{\ISndCode}{a})}})}}%
      {(\IImplies%
      {\ITotal{\IAp{\IAp{e}{(\IAp{\IFstCode}{a})}}{(\IAp{\ISndCode}{a})}}}%
      {\chi\,x\,(\IAp{\IAp{e}{(\IAp{\IFstCode}{a})}}{(\IAp{\ISndCode}{a})})})}
      \]
      %
      and this proves our claim that
      \(\IAbs{a}{\IPAp{\IPAp{e}{(\IPAp{\IPAp{\IFstCode}{a}})}}{(\IPAp{\IPAp{\ISndCode}{a}})}}\)
      evidences \(\TLeq{\TAnd{\phi}{\psi}}{\chi}\).

      Conversely, if \(\TLeq{\TAnd{\phi}{\psi}}{\chi}\) is evidenced by \(e\)
      then \(\TLeq{\phi}{\TImplies{\psi}{\chi}}\) is evidenced by
      %
      \[
        \IAbs{ab}{\IPAp{e}{(\IPAp{\IPAp{\IPairCode}{a}}{b})}}
      \]
      %
      Suppose that \(\phi\,x\,a\), then \(\ITotal{\IAp{(\IAbs{ab}{\IPAp{e}{(\IPAp{\IPAp{\IPairCode}{a}}{b})}})}{a}}\)
      and is equal to \(\IAbs{b}{\IPAp{e}{(\IPAp{\IPAp{\IPairCode}{a}}{b})}}\),
      so we need to show that this is evidence for \(\TLeq{\psi}{\chi}\).
      %
      Given \(b\) such that \(\psi\,x\,b\), we then know that
      \((\TAnd{\phi}{\psi})\,x\,(\IAp{\IAp{\IPairCode}{a}}{b})\), so
      by assumption we have
      %
      \[
      \IAnd%
      {\IBox{(\ITotal{\IAp{e}{(\IAp{\IAp{\IPairCode}{a}}{b})}})}}%
      {(\IImplies%
      {\ITotal{\IAp{e}{(\IAp{\IAp{\IPairCode}{a}}{b})}}}%
      {\chi\,x\,(\IAp{e}{(\IAp{\IAp{\IPairCode}{a}}{b})})})%
      }
      \]
      which suffices to prove that the code given evidences
      \(\TLeq{\phi}{\TImplies{\psi}{\chi}}\).
  \end{itemize}
\end{proof}

\begin{prop}
  The following defines a functor \(\TSym : \Op{\E} \to \HPA\) into Heyting
  prealgebras:
  %
  \[\begin{array}{lll}
    {\T{X}} \IsDefined {(\IRealPred{X}, \TLeqSym)}&\qquad&
    {\T{(f:X\to Y)}} : T{Y} \to T{X}\\
    &&{\T{(f:X\to Y)}\,\phi} \IsDefined {\phi \circ f}
  \end{array}\]
\end{prop}
\begin{proof}
  We have already seen that this is well defined on objects.
  %
  We also know from general category theory that precomposition is functorial,
  so we are left to show it gives a morphism of Heyting prealgebras:
  %
  this follows directly from the fact that the Heyting prealgebra structure is
  all given pointwise in terms of \(X\).
\end{proof}

\begin{prop}\label{prop:trip-quantifiers}
  Given a morphism \(f : X \to Y\) in \(\E\), the map
  \(\TPullSym{f} : \T{Y} \to \T{X}\), when seen as a monotone map, has left
  and right adjoints, \(\TExistsSym{f} : \T{X} \to \T{Y}\) and
  \(\TForallSym{f} : \T{X} \to \T{Y}\).
\end{prop}
\begin{proof}
  The left adjoint to \(\TPullSym{f} : \T{Y} \to \T{X}\) is defined by
  sending \(\phi : \IRealPred{X}\) to
  %
  \[
    \begin{array}{l}
      \TExists{f}{\phi} : \IRealPred{Y}\\
      {\TExists{f}{\phi}\,y\,a} \IsDefined {\IExists{x:X}{\IAnd{fx=y}{\phi\,x\,a}}}
    \end{array}
  \]
  We can show that that \(\TExistsSym{f}\) is monotonic if \(\TExistsSym{f}\) is
  left adjoint to \(\TPullSym{f}\): we always have
  \(\TLeq{\TExists{f}{\psi}}{\TExists{f}{\psi}}\) which implies that
  \(\TLeq{\psi}{\TPull{f}{(\TExists{f}{\psi})}}\).
  %
  If we assume \(\TLeq{\phi}{\psi}\), then by transitivity we have
  \(\TLeq{\phi}{\TPull{f}{(\TExists{f}{\psi})}}\) and this is equivalent to
  \(\TLeq{\TExists{f}{\phi}}{\TExists{f}{\psi}}\).
  %
  We still need to show they are adjoints: for this fix realizability predicates
  \(\phi:\IRealPred{X}\) and \(\psi:\IRealPred{Y}\) and notice that for all
  \(e:\A\)
  \[
    \IForall%
    {y:Y}%
    {(\IImplies%
      {(\IExists{x:X}{\IAnd{fx=y}{\phi\,x\,a}})}%
      {\IAnd%
        {\IBox{(\ITotal{\IAp{e}{a}})}}%
        {(\IImplies%
          {\ITotal{\IAp{e}{a}}}%
          {\psi\,y\,(\IAp{e}{a})})%
        }})}
  \]
  is equivalent to the below by bringing the existential outside the implication
  \[
    \IForall%
    {y:Y}%
    {\IForall%
      {x:X}%
      {\IImplies%
        {fx=y}%
        {(\IImplies%
          {\phi\,x\,a}%
          {\IAnd%
            {\IBox{(\ITotal{\IAp{e}{a}})}}%
            {(\IImplies%
              {\ITotal{\IAp{e}{a}}}%
              {\psi\,y\,(\IAp{e}{a})})%
            }})}}}
  \]
  and this may be simplified by rewriting \(y\) by \(fx\) giving
  \[
    \IForall%
    {x:X}%
    {\IImplies%
      {\phi\,x\,a}%
      {\IAnd%
        {\IBox{(\ITotal{\IAp{e}{a}})}}%
        {(\IImplies%
          {\ITotal{\IAp{e}{a}}}%
          {\psi\,(fx)\,(\IAp{e}{a})})%
        }}}
  \]
  %
  This implies that a given code \(e:\A\) evidences
  \(\TLeq{\TExists{f}{\phi}}{\psi}\) if and only if it evidences
  \(\TLeq{\phi}{\TPull{f}{\psi}}\),
  so we have adjoints as necessary.

  The right adjoint to \(\T{f} : \T{Y} \to \T{X}\) is defined by
  sending \(\phi : \IRealPred{X}\) to
  %
  \[
    \begin{array}{l}
      \TForall{f}\phi : \IRealPred{Y}\\
      {\TForall{f}\phi\,y\,a}\IsDefined {\IForall{x:X}{\IImplies{fx=y}{\phi\,x\,a}}}
    \end{array}
  \]
  %
  As before, the proof of monotonicity will follow from the adjunction
  condition in a similar manner.
  %
  To prove the adjunction we fix realizability predicates \(\phi:\IRealPred{X}\)
  and \(\psi:\IRealPred{Y}\) and notice that for all \(e:\A\) the statement
  \[
    \IForall%
    {y:Y}%
    {(\IImplies%
      {\phi\,y\,a}%
      {\IAnd%
        {\IBox{(\ITotal{\IAp{e}{a}})}}%
        {(\IImplies%
          {\ITotal{\IAp{e}{a}}}%
          {(\IForall{x:X}{\IImplies{fx=y}{\psi\,x\,(\IAp{e}{a})}})})%
        }})}
  \]
  is equivalent to the following, where we have brought the universal quantifier
  outside the implication
  \[
    \IForall%
    {y:Y}%
    {\IForall%
      {x:X}%
      {\IImplies%
        {fx=y}%
        {(\IImplies%
          {\phi\,y\,a}%
          {\IAnd%
            {\IBox{(\ITotal{\IAp{e}{a}})}}%
            {(\IImplies%
              {\ITotal{\IAp{e}{a}}}%
              {\psi\,x\,(\IAp{e}{a})})%
            }})}}}
  \]
  and by rewriting \(y\) to \(fx\) we get the equivalent statement
  \[
    \IForall%
    {x:X}%
    {\IImplies%
      {\phi\,x\,a}%
      {\IAnd%
        {\IBox{(\ITotal{\IAp{e}{a}})}}%
        {(\IImplies%
          {\ITotal{\IAp{e}{a}}}%
          {\psi\,(fx)\,(\IAp{e}{a})})%
        }}}
  \]
  %
  From this it follows that a code \(e:\A\) evidences
  \(\TLeq{\TPull{f}{\phi}}{\psi}\) if and only if it evidences
  \(\TLeq{\phi}{\TForall{f}{\psi}}\).
\end{proof}

\begin{prop}
  The existential and universal quantifiers of \(\TSym\) satisfy the
  Beck-Chevalley conditions.
\end{prop}
\begin{proof}
  As in~\cite{oostenRealizabilityIntroductionIts2008} it suffices to prove the
  Beck Chevalley condition for the universal quantifier as this implies
  the corresponding condition for the existential quantifier.
  %
  Fix a pullback square
  %
  \[\begin{tikzcd}
      X \arrow[r , "f"] \arrow[d, "g"'] & Y \arrow[d, "h"]\\
      Z \arrow[r , "k"] & W
    \end{tikzcd}\]
  %
  then we will show that \(\TForallSym{f}\circ\TPullSym{g}\) is
  equal to \(\TPullSym{h}\circ\TForallSym{k}\).
  %
  Given \(\phi : \IRealPred{Z}\), \(y:Y\) and \(a:\A\), the composite
  \(\TForall{f}{(\TPull{g}{\phi})}\,y\,a\) unfolds to the following
  %
  \[
    \IForall{x:X}{\IImplies{fx=y}{\phi\,(gx)\,a}}
  \]
  %
  which, by introducing a new name \(z:Z\) for \(gx\), expands out to
  %
  \[
    \IForall{z:Z}{\IForall{x:X}{\IImplies{gx=z}{\IImplies{fx=y}{\phi\,z\,a}}}}
  \]
  %
  then we may turn a universal quantifier into an existential by bringing
  it inside the implication
  %
  \[
    \IForall{z:Z}{\IImplies{(\IExists{x:X}{\IAnd{gx=z}{fx=y}})}{\phi\,z\,a}}
  \]
  %
  and as we had a pullback square in the first place we may rewrite this
  existential statement as the equality \(kx=hy\) giving
  %
  \[
    \IForall{z:Z}{\IImplies{kx=hy}{\phi\,z\,a}}
  \]
  %
  This final statement is the exact definition of
  \(\TPull{h}{(\TForall{k}{\phi})}\,y\,a\) so we are done.
\end{proof}

The missing piece to get an \(\E\)-tripos is the existence of membership
predicates.
%
As \(\E\) is a topos and thus cartesian closed, it suffices to show that we have
a generic element~\cite[pg. 52]{oostenRealizabilityIntroductionIts2008}.

\begin{prop}
  The predicate \(\TGen:\T{(\IFun{\A}{\IProp})}\) given by the identity is a
  generic element of \(\TSym\).
\end{prop}
\begin{proof}
  Fix a type \(X\) and \(\phi : \IRealPred{X}\), given \(x:X\) and \(a:\A\) we
  can compute
  %
  \[
    \TPull{\phi}{\TGen}\,x\,a=\TGen\,(\phi\,x)\,a=\phi\,x\,a
  \]
  %
  so \(\TPull{\phi}{\TGen}\) and \(\phi\) are equal predicates (and
  hence also equivalent).
\end{proof}

With this we conclude that \(\TSym\) is an \(\E\)-tripos.

\subsection{Tripos delaying computation and strengthening logical power}%
\label{sub:vo-tripos}

We now present the definition of a tripos first given
in~\cite[\S6.3]{vanoostenExercisesRealizability2018}.

\begin{defn}\label{defn:vo-tripos-ordering}
  Given a type \(X\) and realizability predicates
  \(\phi,\psi : \IRealPred{X}\) we define the \definiendum{evidence predicate
    for \(\TLeqCl{\phi}{\psi}\)} as follows:
  %
  \begin{align*}
    \IEvidenceCl{\phi}{\psi}
    &: \IRealPredCl{X}
    \\
    {\IEvidenceCl{\phi}{\psi}\,x\,e}
    &\IsDefined
      \IForall%
      {a:\A}%
      {\IImplies%
      {\phi\,x\,a}%
      {\IBox{(\IAnd{\ITotal{\IAp{e}{a}}}{\psi\,x\,(\IAp{e}{a})})}}}
  \end{align*}
  %
  We then define the \definiendum{ordering \(\TLeqClSym\) on realizability
    predicates} by saying \(\TLeqCl{\phi}{\psi}\) if there exists a
  code~\(e : \A\) such that for all \(x : X\) we have
  \(\IEvidenceCl{\phi}{\psi}\,x\,e\).
\end{defn}

This gives us another Heyting algebra structure on \(\IRealPred{X}\).

\begin{prop}
  For all types \(X\), the type \(\IRealPred{X}\) equipped with the
  ordering \(\TLeqClSym\) is a Heyting prealgebra.
\end{prop}

Curiously, we can show that in \((\IRealPred{X},\TLeqClSym)\) every
realizability predicate is equivalent to its boxed version.
%
That is, for all \(\phi\) we have \(\TLeqCl{\phi}{\IBox{\phi}}\) and
\(\TLeqCl{\IBox{\phi}}{\phi}\).
%
As such, we might as well restrict ourselves to only the stable realizability
predicates as that gives us an equivalent, but not isomorphic, Heyting
prealgebra.

\begin{defn}\label{defn:vo-tripos-predicates}
  Given a type \(X\), we define \definiendum{stable realizability predicates
  on \(X\)} as the function space \(\IRealPredCl{X}\).
\end{defn}

\begin{prop}
  The functor \(\TClSym : \E \to \HPA\) defined below is an \(\E\)-tripos:
  %
  \[\begin{array}{lll}
    {\TCl{X}} \IsDefined {(\IRealPredCl{X}, \TLeqClSym)}&\qquad&
    {\TCl{(f:X\to Y)}} : \TCl{Y} \to \TCl{X}\\
    &&{\TCl{(f:X\to Y)}\,\phi} \IsDefined {\phi \circ f}
  \end{array}\]
\end{prop}

The attentive reader might wonder what the Heyting prealgebra structure looks
like as we have omitted such proofs.
%
As we will show now, \(\TClSym\) is a subtripos of \(\TSym\) so that will allow
us to derive all of its structure automatically.

\begin{prop}
  The tripos \(\TClSym\) is a subtripos of \(\TSym\), that is we have an adjoint
  pair \(\TInvSym \dashv \TDirSym\) of natural transformations such that for all
  \(X\), the inverse image map \(\TInv{X} : \T{X} \to \TCl{X}\) preserving
  finite meets and the direct image map \(\TDir{X} : \TCl{X} \to \T{X}\) is
  fully faithful.
\end{prop}
\begin{proof}
  First let us define our natural transformations: for each \(X\) we let
  %
  \[\begin{array}{l}
      \TDir{X} : \IFun{(\IRealPredCl{X})}{(\IRealPred{X})}
      \\
      \TDir{X}\,\phi\,x\,a \IsDefined \phi\,x\,a
  \end{array}\]
  %
  be given by forgetting that the predicates are stable, and let
  %
  \[\begin{array}{l}
      \TInv{X} : \IFun{(\IRealPred{X})}{(\IRealPredCl{X})}
      \\
      \TInv{X}\,\phi\,x\,a \IsDefined \IBox{\phi\,x\,a}
  \end{array}\]
  %
  be given by sending \(\phi\) to \(\IBox{\phi}\).

  First we show this gives a geometric morphism from \(\TClSym\) to \(\TSym\).
  %
  Given predicates \(\phi:\IRealPred{X}\) and \(\psi:\IRealPredCl{X}\) we will
  show that \(\TLeqCl{\IBox{\phi}}{\psi}\) and \(\TLeq{\phi}{\psi}\) have the
  same set of realizers.
  %
  Fix a code \(e:\A\) and \(x:X\), then we have the following equivalences
  %
  \begin{align*}
    \IImplies%
    {\IBox{(\phi\,x\,a)}}%
    {\IBox%
    {(\IAnd%
    {\ITotal{\IAp{e}{a}}}%
    {\psi\,x\,(\IAp{e}{a})})}}
    &\IIFFSym
      \IImplies%
      {\phi\,x\,a}%
      {\IBox%
      {(\IAnd%
      {\ITotal{\IAp{e}{a}}}%
      {\psi\,x\,(\IAp{e}{a})})}}
    \\
    &\IIFFSym
      \IImplies%
      {\phi\,x\,a}%
      {(\IAnd%
      {\IBox{(\ITotal{\IAp{e}{a}})}}%
      {\IImplies%
      {(\ITotal{\IAp{e}{a}})}%
      {\psi\,x\,(\IAp{e}{a})}})}
  \end{align*}
  %
  where the first equivalence holds as the succedent is a stable proposition and
  the second equivalence holds by~\Cref{prop:boxed-squash-and-boxed-squish}.
  %
  This shows that the inverse image map is left adjoint to the direct image map
  leaving us to show that the inverse image preserves finite meets.
  %
  Since \(\IBox{\TTop}=\TTop\), we immediately see that the top element is
  preserved.
  %
  This leaves binary meets so fix \(\phi,\psi:\IRealPred{X}\) and we will show
  that \(\IBox{(\TAnd{\phi}{\psi})}\) is the meet of \(\IBox{\phi}\)
  and \(\IBox{\psi}\):
  %
  by the foregoing we have \(\TLeqCl{\IBox{(\TAnd{\phi}{\psi})}}{\IBox{\phi}}\)
  if and only if \(\TLeq{(\TAnd{\phi}{\psi})}{\IBox{\phi}}\) and this holds as
  \(\TLeq{\phi}{\IBox{\phi}}\).
  %
  We are left to show that if \(e_{0}\) evidences \(\TLeqCl{\chi}{\IBox{\phi}}\)
  and \(e_{1}\) evidences \(\TLeqCl{\chi}{\IBox{\psi}}\), then
  \(\IAbs{a}{\IPAp{\IPAp{\IPairCode}{(\IPAp{e_{0}}{a})}}{(\IPAp{e_{1}}{a})}}\)
  evidences \(\TLeqCl{\chi}{\IBox{(\TAnd{\phi}{\psi})}}\) for all stable
  predicates \(\chi\).
  %
  Assume that \(\chi\,x\,a\), {\color{red} todo: finish this}

  % , \(a:\A\) and \(x:X\), then we have the following
  % equivalences
  % \begin{align*}
  %   &
  %     \IBox{(\IAnd%
  %     {(\IAnd{\ITotal{\IPAp{\IFstCode}{a}}}{\phi\,x\,(\IPAp{\IFstCode}{a})})}%
  %     {(\IAnd{\ITotal{\IPAp{\ISndCode}{a}}}{\psi\,x\,(\IPAp{\ISndCode}{a})})})}
  %   \\
  %   &\IIFFSym
  %     \IAnd%
  %     {\IBox{(\IAnd{\ITotal{\IPAp{\IFstCode}{a}}}{\phi\,x\,(\IPAp{\IFstCode}{a})})}}%
  %     {\IBox{(\IAnd{\ITotal{\IPAp{\ISndCode}{a}}}{\psi\,x\,(\IPAp{\ISndCode}{a})})}}
  %   \\
  %   &\IIFFSym
  %     \IAnd%
  %     {(\IAnd{\ITotal{\IPAp{\IFstCode}{a}}}{\IBox{(\phi\,x\,(\IPAp{\IFstCode}{a}))}})}%
  %     {(\IAnd{\ITotal{\IPAp{\ISndCode}{a}}}{\IBox{(\psi\,x\,(\IPAp{\ISndCode}{a}))}})}
  % \end{align*}
  % where
  % the first equivalence holds since \(\IBoxSym\) preserves conjunctions
  % and the second holds by \Cref{prop:}

  Finally we show this geometric morphism is an inclusion of triposes, i.e.\ the
  direct image map \(\TDir{X}\) preserves and reflects the ordering for all
  \(X\).
  %
  Given stable predicates \(\phi,\psi : \IRealPredCl{X}\), we can use
  \Cref{prop:boxed-squash-and-boxed-squish} to show that a code \(e\) evidences
  \(\TLeqCl{\phi}{\psi}\) if and only if it evidences \(\TLeq{\phi}{\psi}\).
\end{proof}

This implies that \(\PER{\E}{\TClSym}\) is a subtopos of \(\PER{\E}{\TSym}\).
%
It is not entirely clear at this point what \(\PER{\E}{\TClSym}\) looks like,
but now recall some results
from~\cite[\S6.3]{vanoostenExercisesRealizability2018}.

\begin{lemm}\label{prop:vo-extension-of-evidence-predicate}
  Extension of realizability predicates commutes with the evidence
  predicate, that is for all \(d:\ISheaf{X}\) and \(e:\A\) we have
  %
  \(
    \IRPExt{\IEvidenceCl{\phi}{\psi}}\,d\,e
    \Leftrightarrow
    \IEvidenceCl{\IRPExt{\phi}}{\IRPExt{\psi}}\,d\,e
  \).
\end{lemm}
\begin{proof}
  Unfold the definition of \(\IEvidenceClSym\) and apply
  Propositions~\ref{prop:heyting-structure-predicate-extension}
  and~\ref{prop:boxed-existential-partial-extension}.
\end{proof}

\begin{prop}
  Given a type \(X\), we have an isomorphism
  \(\IRPExt{(-)} \dashv (-\circ\ILeafSym)\)
  between the preorder of realizability predicates on \(X\)
  and the preorder of realizability predicates on \(\ISheaf{X}\).
  %
  Furthermore, this isomorphism is natural in \(X\).
\end{prop}
\begin{proof}
  We must show that the following two maps
  \[
    \IRPExtSym : {(\IRealPredCl{X})} \rightleftarrows {(\IRealPredCl{\ISheaf{X}})} : (-\circ\ILeafSym)
  \]
  give an equivalence of preorders, that the first is left adjoint to the
  second and that they are natural in \(X\).
  %
  From our axiomatisation of sheafification as an adjunction we get
  for free the naturality in \(X\) and that the two maps are inverses.
  %
  To prove that both maps preserve the ordering of realizability predicates
  we show instead that \(\IRPExtSym\) both preserves and reflects the order,
  which follows from \Cref{prop:stable-predicate-induction} and
  the preceding \Cref{prop:vo-extension-of-evidence-predicate}.
\end{proof}

This tells us that in \(\PER{\E}{\TClSym}\) we can assume that the underlying
object of each partial equivalence relation is a sheaf.

\newpage

\section{Prototypical examples}

\subsection{Van Oosten's indexed pca}

\subsection{Choice sequences as neutral terms}

We have chosen to work with combinatory terms for simplicity, though
nothing in this example should be specific to a combinatory setting
as opposed to a setting with binders.

We start with the following inductively defined set of codes:
%
\[
  (\textbf{Codes}) \quad
  M,N\vcentcolon\vcentcolon=
  K \mid
  S \mid
  C \mid
  M N
\]

Now we define a set of congruence relations on \(\textbf{Codes}\) which are
indexed by lists of natural numbers. For a list of natural numbers \(l\), we let
\(M \equiv_{l} N\) be the least congruence generated by:
%
\begin{mathpar}
  \inferrule%
  { }%
  {{KMN} \equiv_{l} {M}}

  \inferrule%
  { }%
  {{SMNP} \equiv_{l} {MP(NP)}}

  \inferrule%
  {{l \mathop{!!} n} = {\text{just}(m)}}%
  {{C_{1}\bar{n}} \equiv_{l} {\bar{m}}}
\end{mathpar}
%
where we are using \(\bar{n}\) to denote the Church encoding of the natural
number \(n\), which we may define in terms of \(K\) and \(S\).
%
Notice that if \(l\) is a prefix of \(m\), then we have that
\({\equiv_{l}} \subseteq {\equiv_{m}}\).

\begin{defn}
  We define a total combinatory algebra \((\A,{\cdot})\) internal to the category
  of presheaves over the preorder \(\mathbb{W}\) of lists of natural numbers
  ordered by the opposite prefix ordering.
  %
  The underlying presheaf is given by sending a list \(w\)
  to the set quotient~\(\textbf{Codes}/{\equiv_{l}}\) and
  the transition maps are given by the quotient maps arising out of the
  monotonicity of \({\equiv_{(-)}}\).
  %
  The application natural transformation is given by concatenation of codes, and
  the interpretation of \(k\) and \(s\) is given by the global elements
  associated with \(K\) and \(S\) respectively.
\end{defn}

If we work with the notion of Beth covering, then \(\A\) is not separated.
%
If we use the combinatory structure to define a multiplication combinator
\({Mult}:\textbf{Codes}\) which works by inducting on the first argument, then
we for any non-empty list \(l\) we will have
%
\[
  {{Mult}\,(C\bar{0})\,\bar{0}} \equiv_{l} \bar{0}
\]
%
as \(C\bar{0}\) will be equal to an actual numeral, and then we can keep
evaluating the expression.
%
However, this equality will not hold at the empty list, since \(C{\bar{0}}\)
will act as a neutral and block evaluation.
%
In particular, this means that the interpretation of the pure natural numbers
in the presheaf realizability topos will not be isomorphic to the
its sheafification.

\newpage

\section{Further questions}

A to do list of questions regarding this work:
%
\begin{itemize}
  \item How can we sheafify a pca \(\A\) axiomatically?
  \item Is the tripos \(\TSym\) for \(\A\) a subtripos of the usual realizability
    tripos for \(\ISheaf{\A}\)?
  \item Is there any connection between assemblies for van Oosten's tripos and
    \(\TSym\)-assemblies?
\end{itemize}

\newpage

\printbibliography{}

\end{document}
